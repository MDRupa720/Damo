<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Table Add | Data Entry</title>
  <style>
    :root {
      --border:#e5e7eb;
      --bg:#ffffff;
      --muted:#6b7280;
      --hover:#f8fafc;
      --focus:#3b82f6;
      --header:#f9fafb;
      --success-bg:#ecfdf5;
      --success-border:#10b981;
      --success-text:#065f46;
      --error-bg:#fef2f2;
      --error-border:#ef4444;
      --error-text:#991b1b;
    }
    * { box-sizing: border-box; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin: 20px; color: #111827; background: var(--bg); }
    h2 { margin: 0 0 12px; font-weight: 700; }
    .top-bar { display: flex; gap: 10px; align-items: center; margin-bottom: 12px; flex-wrap: wrap; }
    select, button { padding: 8px 12px; font-size: 14px; border-radius: 8px; border: 1px solid var(--border); background: #fff; }
    button { cursor: pointer; background: #0ea5e9; border-color: #0ea5e9; color: #fff; font-weight: 600; }
    button:hover { filter: brightness(0.98); }
    button:active { transform: translateY(0.5px); }
    .muted { color: var(--muted); font-size: 13px; }

    .message { margin: 10px 0; padding: 10px 12px; border-radius: 8px; display: none; border: 1px solid transparent; }
    .message.show { display: block; }
    .message.success { background: var(--success-bg); color: var(--success-text); border-color: var(--success-border); }
    .message.error { background: var(--error-bg); color: var(--error-text); border-color: var(--error-border); }

    .table-wrapper { border: 1px solid var(--border); border-radius: 10px; overflow: auto; max-height: 70vh; box-shadow: 0 1px 2px rgba(0,0,0,.05); }
    table { border-collapse: separate; border-spacing: 0; width: max-content; min-width: 100%; }
    th, td { border: 1px solid var(--border); padding: 8px; text-align: left; min-width: 120px; font-size: 14px; vertical-align: top; background: #fff; }
    tbody tr:nth-child(even) td { background: #fcfcfd; }
    tbody td:hover { background: var(--hover); }
    th[contenteditable="true"], td[contenteditable="true"] { outline: none; }
    td:focus, th:focus { box-shadow: inset 0 0 0 2px var(--focus); background: #eef4ff; }

    /* Sticky header */
    thead th { position: sticky; top: 0; background: var(--header); z-index: 3; }

    /* Row number (left) sticky like Excel */
    .row-header { position: sticky; left: 0; z-index: 2; background: var(--header); min-width: 64px; text-align: center; font-weight: 600; }
    /* Top-left corner sticky */
    .corner { position: sticky; top: 0; left: 0; z-index: 5; background: var(--header); }

    /* Scrollbar styling (optional) */
    .table-wrapper::-webkit-scrollbar { height: 10px; width: 10px; }
    .table-wrapper::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 8px; }
    .table-wrapper::-webkit-scrollbar-track { background: #f1f5f9; }
  </style>
</head>
<body>
  <h2>ডেটা যোগ করুন</h2>

  <div class="top-bar">
    <label for="classSelect"><strong>ক্লাস:</strong></label>
    <select id="classSelect"></select>
    <button id="saveBtn">Save</button>
    <span class="muted">উপরে ২০টা কলাম, নিচে ১০২টা রো। ডেটা লিখে Save চাপুন।</span>
  </div>

  <div id="msgBox" class="message"></div>

  <div class="table-wrapper">
    <table id="sheetTable">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    // Config
    const TOTAL_COLUMNS = 20;   // উপরের কলাম সংখ্যা (A–T)
    const TOTAL_ROWS = 102;     // নিচের দিকে রো সংখ্যা (১–১০২)

    const classes = ["Play", "Nursery", "Kg", "1","2","3","4","5","6","7","8","9","10"];

    const classSelect = document.getElementById('classSelect');
    const saveBtn = document.getElementById('saveBtn');
    const msgBox = document.getElementById('msgBox');
    const table = document.getElementById('sheetTable');
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');

    // Dropdown populate
    function populateClasses() {
      classes.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        classSelect.appendChild(opt);
      });
      classSelect.value = "Play";
    }

    // Excel-like column labels: A, B, ... Z, AA, AB, ...
    function colLabel(index) {
      let s = "";
      index += 1;
      while (index > 0) {
        const rem = (index - 1) % 26;
        s = String.fromCharCode(65 + rem) + s;
        index = Math.floor((index - 1) / 26);
      }
      return s;
    }

    // Build table: 1 corner + 20 column headers; 102 rows with left row-number header
    function buildTable(rows = TOTAL_ROWS, cols = TOTAL_COLUMNS) {
      // Header
      const trHead = document.createElement('tr');
      // Top-left corner cell (row header title)
      const corner = document.createElement('th');
      corner.className = 'corner row-header';
      corner.textContent = '#';
      trHead.appendChild(corner);

      const headFrag = document.createDocumentFragment();
      for (let c = 0; c < cols; c++) {
        const th = document.createElement('th');
        th.contentEditable = "true"; // চাইলে শিরোনাম বদলাতে পারবেন
        th.textContent = colLabel(c);
        th.setAttribute('data-col', c);
        headFrag.appendChild(th);
      }
      trHead.appendChild(headFrag);
      thead.innerHTML = '';
      thead.appendChild(trHead);

      // Body
      tbody.innerHTML = '';
      const bodyFrag = document.createDocumentFragment();
      for (let r = 0; r < rows; r++) {
        const tr = document.createElement('tr');

        // Row number header (sticky left)
        const rh = document.createElement('th');
        rh.className = 'row-header';
        rh.scope = 'row';
        rh.textContent = r + 1;
        tr.appendChild(rh);

        // Data cells
        const rowFrag = document.createDocumentFragment();
        for (let c = 0; c < cols; c++) {
          const td = document.createElement('td');
          td.contentEditable = "true";
          td.setAttribute('data-row', r);
          td.setAttribute('data-col', c);
          rowFrag.appendChild(td);
        }
        tr.appendChild(rowFrag);
        bodyFrag.appendChild(tr);
      }
      tbody.appendChild(bodyFrag);
    }

    function showMessage(text, type = 'success') {
      msgBox.textContent = text;
      msgBox.className = `message show ${type}`;
      setTimeout(() => {
        msgBox.className = 'message'; // auto hide
      }, 3500);
    }

    // Collect table data into JSON (ignores the row-number column)
    function collectTableData() {
      const headers = Array.from(thead.querySelectorAll('th[data-col]')).map(th => th.textContent.trim());
      const rows = Array.from(tbody.querySelectorAll('tr')).map(tr => {
        return Array.from(tr.querySelectorAll('td')).map(td => td.textContent.trim());
      });
      return { headers, rows };
    }

    async function saveData() {
      const className = classSelect.value;
      if (!className) {
        showMessage('দয়া করে একটি ক্লাস নির্বাচন করুন।', 'error');
        return;
      }
      const tableData = collectTableData();

      try {
        const res = await fetch('data_table.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'save',
            className,
            tableData
          })
        });
        if (!res.ok) throw new Error('Network error');
        const data = await res.json();

        if (data.success) {
          showMessage(data.message || 'ডেটা সফলভাবে সেভ হয়েছে ✅', 'success');
        } else {
          showMessage(data.message || 'সেভ করা যায়নি।', 'error');
        }
      } catch (e) {
        showMessage('সার্ভারে পৌঁছানো যায়নি।', 'error');
      }
    }

    // Init
    populateClasses();
    buildTable(TOTAL_ROWS, TOTAL_COLUMNS);
    saveBtn.addEventListener('click', saveData);
  </script>
</body>
</html>